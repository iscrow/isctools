#!/usr/bin/env bash

SNMP_TIMEOUT=2
SCRIPT="$(basename "$0")"

function help() {
	cat <<-EOF

		$SCRIPT [-l|--long] switch_ips
		  -l or --long shows full info that is not needed most of the time
	
		Usage example:
		  $SCRIPT returns the model of the switch. Usage:
		  $SCRIPT 192.168.3.11 192.168.3.12

	EOF
	return 1 2>&- || exit 1
}

POSITIONAL=()
while [[ $# -gt 0 ]]
do
key="$1"

case $key in
	-l|--long)
	LONG="yes"
	shift # past argument
	;;
	-h|--help)
		help
	;;
	*)    # unknown option
	POSITIONAL+=("$1") # save it in an array for later
	shift # past argument
	;;
esac
done
set -- "${POSITIONAL[@]}" # restore positional parameters

PARAMS=$*
[ ! -t 0 ] && PARAMS="$(cat | tr '\n' ' ' | tr '\r' ' ') $PARAMS"
[ -z "$PARAMS" ] && help

SNMP_RO_COMMUNITY="public"
[ -n $(command -v pktools_vars) ] && . pktools_vars

for SWITCH in $PARAMS; do
	SWITCH=$(ip_validate $SWITCH)
	[ -z "$SWITCH" ] && echo "$SWITCH: Invalid IP address" >&2 && help

	MODEL=$(timeout $SNMP_TIMEOUT snmpget -v2c -c$SNMP_RO_COMMUNITY $SWITCH 1.3.6.1.2.1.1.1.0 -Oe 2>&- | sed -E 's/.*STRING: //')
	if [ -z "$MODEL" ]; then
		. aruba_auth
		MODEL=$(aruba_command $SWITCH "getmib 1.3.6.1.2.1.1.1.0" | grep -Pv '^\s*$' | sed -E 's/^[^=]+ *= *//')
	fi
	[ -z "$LONG" ] && MODEL=$(sed -E 's|\(/ws/[^)]+\)\)||g;s|\(Formerly ProCurve\)||g' <<< "$MODEL")

	echo -n "$SWITCH: "
	[ -n "$MODEL" ] && echo "$MODEL" || echo "Could not determine model"
done
