#!/usr/bin/env bash

SNMP_TIMEOUT=2
SCRIPT="$(basename "$0")"

function help() {
	cat <<-EOF

		$SCRIPT switch_ips$_description_of_functionality_
	
		Usage example:
		  $SCRIPT returns the model of the switch. Usage:
		  $SCRIPT 192.168.3.11 192.168.3.12

	EOF
	return 1 2>&- || exit 1
}

grep -Piq -- '--help|-h' <<< $* && help

PARAMS=$*
[ ! -t 0 ] && PARAMS="$(cat | tr '\n' ' ' | tr '\r' ' ') $PARAMS"
[ -z "$PARAMS" ] && help

SNMP_RO_COMMUNITY="public"
[ -n $(command -v pktools_vars) ] && . pktools_vars

for SWITCH in $PARAMS; do
	SWITCH=$(ip_validate $SWITCH)
	[ -z "$SWITCH" ] && echo "$SWITCH: Invalid IP address" >&2 && help

	MODEL=$(timeout $SNMP_TIMEOUT snmpget -v2c -c$SNMP_RO_COMMUNITY $SWITCH 1.3.6.1.2.1.1.1.0 -Oe 2>&- | sed -E 's/.*STRING: //')
	if [ -z "$MODEL" ]; then
		. aruba_auth
		MODEL=$(aruba_command $SWITCH "getmib 1.3.6.1.2.1.1.1.0" | grep -Pv '^\s*$' | sed -E 's/^[^=]+ *= *//')
	fi

	echo -n "$SWITCH: "
	[ -n "$MODEL" ] && echo "$MODEL" || echo "Could not determine model"
done
